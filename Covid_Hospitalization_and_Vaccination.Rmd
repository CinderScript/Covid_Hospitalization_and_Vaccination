---
title: "Covid Hospitalization and Vaccination Study"
author: "Gregory Maynard"
date: "`r Sys.Date()`"
output: openintro::lab_report
---

# Required Packages and Global Variables

required packages:

```{r load-packages, message=FALSE}
library(openintro)

library(tidyverse)
library(lubridate)

# for map data
library(albersusa)

# for SODA API calls
library(httr)
library(jsonlite)
```


Global Vars:
 
```{r}

# hospital data endpoint to soda api
hospital_data_soda_endpoint <- "https://healthdata.gov/resource/anag-cw7u.json"

# needed to avoid api throttling
healthdata_soda_app_token <- "3tl81UiFuoaJ1DboeqMuy5K9U"

# api url for arcgis hrr boundary shape data
hrr_boundary_arcgis_endpoint = "https://services.arcgis.com/nzS0F0zdNLvs7nc8/arcgis/rest/services/HRR_boundaries/FeatureServer"

#cached data
cached_data_folder_base = "cached-data"
cached_bed_data_folder = paste(cached_data_folder_base, "hospital_bed_usage", sep = "/")
cached_vaccination_data_folder = paste(cached_data_folder_base, "vaccination_rates", sep = "/")

cached_hrr_shapes_filepath = paste(cached_data_folder_base, "hhr_shapes_arcgis_data.shape", sep = "/")
cached_hospital_bed_data_filepath = paste(cached_bed_data_folder, "hospital_bed_usage_healthdatagov_", sep = "/")
cached_vaccination_data_filepath = paste(cached_vaccination_data_folder, "vaccination_rates_cdc_", sep = "/")

```


# Helper Functions

```{r}
# Returns a dataframe from the given soda api endpoint. 
get_soda_dataframe <- function(endpoint, simple_filter = NULL, where_filter, select_filter, limit = 1000, app_token){
  
  #Build the query
  soda_query = paste0(endpoint, 
            "?",                                      
             simple_filter,
             "&$where=", where_filter,
             "&$select=", select_filter,
             "&$limit=", limit,
             "&$$app_token=", app_token)
  
  # Getting response details in API
  response_details = GET(url = URLencode(soda_query))
  
  # Getting status of HTTP Call
  response_status_code = status_code(response_details)
  
  print(paste0("SODA http response: ", response_status_code))
  
  # Converting content to text
  response_content_text = content(response_details,
                            "text", encoding = "UTF-8")
   
  # Parse Json Data
  response_content_json = fromJSON(response_content_text,
                             flatten = TRUE)
   
  # Converting into dataframe
  soda_dataframe = as.data.frame(response_content_json)
}

### HOSPITAL BED DATA ###

# gets dataframe with total inpatient beds, used inpatient beds, and used inpatient beds for covid patients, 
# for each hospital on record for the week given (date). This request asks for the first 10,000 records. A typical
# week on this dataset has between 3,000 and 6,000 records.
get_bed_utilization_healthdata_gov_soda_api <- function(date){
  
  get_soda_dataframe(
    endpoint = hospital_data_soda_endpoint,
    #simple_filter = "state='WA'",                              # can add this for smaller dataset for testing (fast soda api call)
    where_filter = paste0("collection_week='",date, "'"),
    select_filter = "state,hospital_name,city,fips_code,inpatient_beds_7_day_avg,inpatient_beds_used_7_day_avg,inpatient_beds_used_covid_7_day_avg",
    limit = 10000,
    app_token = healthdata_soda_app_token) %>% 
    
    # Converting value types #
    
    # convert values to numeric
    mutate(
      fips_code = as.numeric(fips_code),
      inpatient_beds_7_day_avg = as.numeric(inpatient_beds_7_day_avg),
      inpatient_beds_used_7_day_avg = as.numeric(inpatient_beds_used_7_day_avg),
      inpatient_beds_used_covid_7_day_avg = as.numeric(inpatient_beds_used_covid_7_day_avg)) %>% 

    # replace negative bed counts with NA
    mutate(
      inpatient_beds_7_day_avg = ifelse(inpatient_beds_7_day_avg > -1, inpatient_beds_7_day_avg, NA),
      inpatient_beds_used_7_day_avg = ifelse(inpatient_beds_used_7_day_avg > -1, inpatient_beds_used_7_day_avg, NA),
      inpatient_beds_used_covid_7_day_avg = ifelse(inpatient_beds_used_covid_7_day_avg > -1, inpatient_beds_used_covid_7_day_avg, NA))
}

# Checks for data in the cached data folder first, then looks for the data using the soda rest api
get_bed_utilization_data <- function(date){
  
  #convert date to string soda api likes
  yyyy_mm_dd = ymd(date)
  
  # first we need to determine the filename of the cached data file.
  filepath = paste0(cached_hospital_bed_data_filepath, yyyy_mm_dd, ".csv")
  
  if( !file.exists(filepath) ) {
    
    # get from healthdata.gov
    
    print("Hospital bed cached data was not found. Retrieving from healthdata.gov (soda api)...")
    bed_data = get_bed_utilization_healthdata_gov_soda_api(date = yyyy_mm_dd)
    
    write_csv(bed_data, filepath)
    print("File retrieved and cached for future use.")
  }
  else {
    
    # get from cached data file
    
    bed_data = read_csv(filepath, show_col_types = FALSE)
    print("Hospital bed data loaded from local cache.")
  }
  
  return(bed_data)
}


### HRR BOUNDARY MAP DATA ###

# get hrr shapefile data from arcgis
get_hrr_shapes_arcgis_featureserver_api <- function() {
  
  if( !file.exists(cached_hrr_shapes_filepath) ) {
  
    print("No cached hrr shapefile was found. Downloading from arcgis and saving to file...")
    
    # get and save the file
    url = parse_url(hrr_boundary_arcgis_endpoint)
    url$path = paste(url$path, "0/query", sep = "/")
    url$query = list(where = "HRRNUM > -1",
                      outFields = "*",
                      returnGeometry = "true",
                      f = "geojson")
    request = build_url(url)
    
    hrr_shape_data = st_read(request)
    
    st_write(hrr_shape_data, cached_hrr_shapes_filepath, driver = "GeoJSON")
  }
  else {
    hrr_shape_data = st_read(cached_hrr_shapes_filepath)
    print("HRR shapes data loaded from local cache.")
  }
  
  return(hrr_shape_data)
}


create_data_folder_if_dne <- function(){
  if ( !dir.exists(file.path(cached_data_folder_base)) ) {
    print("Creating cached data folder...")
    dir.create(cached_data_folder_base)
    dir.create(cached_bed_data_folder)
    dir.create(cached_vaccination_data_folder)
  }
  else
    print("Founds cached data folder.")
}

# ggplot theme function
my_map_theme <- function(){
  theme(panel.background=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank(),
        axis.title=element_blank())
}

```

# Get Required Datasets

Datasets are first looked for in the cached data folder, then downloaded if not found.

 "Query:  https://healthdata.gov/resource/anag-cw7u.json?&$where=collection_week='2023-02-24'&$select=state,hospital_name,city,fips_code,inpatient_beds_7_day_avg,inpatient_beds_used_7_day_avg,inpatient_beds_used_covid_7_day_avg&$limit=10000&$$app_token=3tl81UiFuoaJ1DboeqMuy5K9U"
 
"Query:  https://healthdata.gov/resource/anag-cw7u.json?state='WA'&$where=collection_week=2021-09-24&$select=state,hospital_name,city,fips_code,inpatient_beds_7_day_avg,inpatient_beds_used_7_day_avg,inpatient_beds_used_covid_7_day_avg&$limit=10000&$$app_token=3tl81UiFuoaJ1DboeqMuy5K9U"

```{r}
create_data_folder_if_dne()

hrr_data <- get_hrr_shapes_arcgis_featureserver_api()

bed_data <- get_bed_utilization_data(date = '2021/09/24')
```


# Data Sources

## Hospital Capacity Data

Hospital bed usage counts is obtained from HealthData.gov: https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/anag-cw7u. This dataset is over 300 MB, so instead of downloading the whole dataset, this application accesses it through the SODA API.

The "COVID-19 Reported Patient Impact and Hospital Capacity by Facility" provides data on hospital bed utilization that is aggregated weekly.

The variables we are using are:
* **Hospital_name** and **fips_code**
* **inpatient_beds_7_day_avg**: Average number of total number of staffed inpatient beds in your hospital including all overflow, observation, and active surge/expansion beds used for inpatients (including all ICU beds) reported in the 7-day period.
* **inpatient_beds_used_7_day_avg**: Average of total number of staffed inpatient beds that are occupied reported during the 7-day period.
* **inpatient_beds_used_covid_7_day_avg**: Average of reported patients currently hospitalized in an inpatient bed who have suspected or confirmed COVID-19 reported during the 7-day period.

*Inpatient bed counts are used instead of total bed counts because many hospitals that only have inpatient bed data do not include data for inpatient and outpatient totals.*

We also calculate: 
* **bed_usage_ratio**: The ratio of hospital beds used out of 100 beds (inpatient)
* **covid_bed_usage_ratio**: The ratio of hospital beds used by covid patients out of 100 beds (inpatient)
* **covid_bed_usage_total_bed_usage_ratio**: The ratio of hospital beds used by covid patients out of all used beds (inpatient)

```{r}

# get data
hospital_bed_data <- get_healthdata_gov_bed_utilization_from_soda(date = '2021/09/24')

# calculate ratios
hospital_bed_data <- hospital_bed_data %>% 
  mutate(
    bed_usage_ratio = inpatient_beds_used_7_day_avg / inpatient_beds_7_day_avg * 100,
    covid_bed_usage_ratio = inpatient_beds_used_covid_7_day_avg / inpatient_beds_7_day_avg * 100,
    covid_bed_usage_total_bed_usage_ratio = inpatient_beds_used_covid_7_day_avg / inpatient_beds_used_7_day_avg
  )

```


## Map Geometry Data

county and state map geometry

```{r}

us_county_map_geometry <- counties_sf("laea") %>% 
  mutate(fips = as.numeric(as.character(fips)))

wa_counties_map_geometry <- counties_sf() %>% 
  mutate(fips = as.numeric(as.character(fips))) %>% 
  filter(iso_3166_2 == "WA")


```

Hospitals are grouped by county using their fips code and then averages for bed ratios are calculated for each county.

```{r}
county_bed_ratios <- hospital_bed_data %>% 
  group_by(fips_code) %>% 
  summarise(
    bed_usage_ratio = mean(bed_usage_ratio, na.rm = TRUE), 
    covid_bed_usage_ratio = mean(covid_bed_usage_ratio, na.rm = TRUE), 
    covid_bed_usage_total_bed_usage_ratio = mean(covid_bed_usage_total_bed_usage_ratio, na.rm = TRUE))

```



graph covid bed usage ratio

```{r}

wa_counties_map_geometry %>% 
  left_join(bed_ratios, by = c("fips" = "fips_code")) %>% 
  ggplot() +
  geom_sf(aes(fill = covid_bed_usage_ratio)) +
  my_map_theme()

us_county_map_geometry %>% 
  left_join(bed_ratios, by = c("fips" = "fips_code")) %>% 
  ggplot() +
  geom_sf(aes(fill = covid_bed_usage_ratio)) +
  my_map_theme()

```
```{r}

  
```

```{r}
library(sf)

hhr_region_map <- st_read("hhr/Hrr98Bdry_AK_HI_unmodified.shp")

projection <- st_transform(hhr_region_map, 'EPSG:2163')

ggplot(projection) +
  geom_sf()

```


...

